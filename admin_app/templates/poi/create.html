{% extends "templates/accounts/base.html" %}
{% load static %}

{% block content %}
<div class="container-fluid py-4 px-4">
    <!-- Animated Breadcrumb -->
    <nav aria-label="breadcrumb" class="mb-4 breadcrumb-nav">
        <ol class="breadcrumb">
            <li class="breadcrumb-item"><a href="{% url 'admin_app:poi_list' %}">Points of Interest</a></li>
            <li class="breadcrumb-item active">{% if poi %}Edit{% else %}Add{% endif %} Point of Interest</li>
        </ol>
    </nav>

    <div class="row justify-content-center">
        <div class="col-md-10">
            <!-- Form Card with Glass Effect -->
            <div class="card form-card">
                <div class="card-header">
                    <div class="d-flex align-items-center">
                        <div class="icon-container me-3" style="background: linear-gradient(45deg, var(--icon-poi), #FF5252);">
                            <i class="fas fa-{% if poi %}edit{% else %}map-marker-plus{% endif %} fa-lg text-white"></i>
                        </div>
                        <h3 style="font-family: var(--navfont); margin: 0; font-weight: 700; color: #333;">{% if poi %}Edit{% else %}Add{% endif %} Point of Interest</h3>
                    </div>
                </div>
                <div class="card-body p-4">
                    <form method="post" enctype="multipart/form-data" class="needs-validation" novalidate>
                        {% csrf_token %}

                        <div class="row">
                            <div class="col-md-6">
                                <!-- Name Field -->
                                <div class="mb-4 form-group">
                                    <label for="name" class="form-label">Name <span class="text-danger">*</span></label>
                                    <div class="input-group">
                                        <span class="input-group-text"><i class="fas fa-tag"></i></span>
                                        <input type="text" class="form-control" id="name" name="name"
                                               value="{{ poi.name|default:'' }}" placeholder="Enter location name" required>
                                    </div>
                                    <div class="invalid-feedback">
                                        Please enter a point of interest name
                                    </div>
                                </div>

                                <!-- Category Field -->
                                <div class="mb-4 form-group">
                                    <label for="category" class="form-label">Category <span class="text-danger">*</span></label>
                                    <div class="input-group">
                                        <span class="input-group-text"><i class="fas fa-folder"></i></span>
                                        <select class="form-select" id="category" name="category" required>
                                            <option value="">Select Category</option>
                                            {% for category in categories %}
                                                <option value="{{ category.id }}"
                                                    {% if poi and poi.category.id == category.id %}selected{% endif %}>
                                                    {{ category.name }}
                                                </option>
                                            {% endfor %}
                                        </select>
                                    </div>
                                    <div class="invalid-feedback">
                                        Please select a category
                                    </div>
                                </div>

                                <!-- Description Field -->
                                <div class="mb-4 form-group">
                                    <label for="description" class="form-label">Description</label>
                                    <div class="input-group">
                                        <span class="input-group-text"><i class="fas fa-align-left"></i></span>
                                        <textarea class="form-control" id="description" name="description"
                                                  rows="3" placeholder="Enter description">{{ poi.description|default:'' }}</textarea>
                                    </div>
                                </div>

                                <!-- Location Field -->
                                <div class="mb-4 form-group">
                                    <label for="location" class="form-label">Location <span class="text-danger">*</span></label>
                                    <div class="input-group">
                                        <span class="input-group-text"><i class="fas fa-map-pin"></i></span>
                                        <input type="text" class="form-control" id="location" name="location"
                                               value="{{ poi.location|default:'' }}" placeholder="Enter location address" required>
                                    </div>
                                    <div class="invalid-feedback">
                                        Please enter a location
                                    </div>
                                </div>

                                <!-- Coordinates Fields -->
                                <div class="row mb-4">
                                    <div class="col-md-6">
                                        <label for="latitude" class="form-label">Latitude <span class="text-danger">*</span></label>
                                        <div class="input-group">
                                            <span class="input-group-text"><i class="fas fa-compass"></i></span>
                                            <input type="number" step="any" class="form-control" id="latitude" name="latitude"
                                                   value="{{ poi.latitude|default:'' }}" required>
                                        </div>
                                        <div class="invalid-feedback">
                                            Please enter latitude
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <label for="longitude" class="form-label">Longitude <span class="text-danger">*</span></label>
                                        <div class="input-group">
                                            <span class="input-group-text"><i class="fas fa-compass"></i></span>
                                            <input type="number" step="any" class="form-control" id="longitude" name="longitude"
                                                   value="{{ poi.longitude|default:'' }}" required>
                                        </div>
                                        <div class="invalid-feedback">
                                            Please enter longitude
                                        </div>
                                    </div>
                                </div>

                                <!-- Image Upload with Preview -->
                                <div class="mb-4 form-group">
                                    <label for="image" class="form-label">Image</label>
                                    <div class="d-flex mb-3">
                                        <div class="image-preview me-3" id="imagePreview">
                                            {% if poi and poi.image %}
                                                <img src="{{ poi.image.url }}" alt="Current image" class="current-image">
                                            {% else %}
                                                <i class="fas fa-image"></i>
                                            {% endif %}
                                        </div>
                                        <div class="flex-grow-1">
                                            <div class="input-group">
                                                <span class="input-group-text"><i class="fas fa-upload"></i></span>
                                                <input type="file" class="form-control" id="image" name="image" accept="image/*">
                                            </div>
                                            <small class="text-muted">Upload a representative image (recommended size: 800x600px or larger)</small>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div class="col-md-6">
                                <!-- Map Container -->
                                <div class="mb-4 form-group map-container-wrapper">
                                    <label class="form-label">Select Location on Map <span class="text-danger">*</span></label>
                                    <div id="map" class="map-container"></div>
                                    <small class="text-muted mt-2">Click on the map to set the location or drag the marker</small>
                                </div>
                            </div>
                        </div>

                        <!-- Divider -->
                        <div class="form-divider mb-4"></div>

                        <!-- Action Buttons -->
                        <div class="d-flex justify-content-between">
                            <a href="{% url 'admin_app:poi_list' %}" class="btn back-btn">
                                <i class="fas fa-arrow-left me-2"></i> Back to List
                            </a>
                            <button type="submit" class="btn submit-btn">
                                <i class="fas fa-save me-2"></i> {% if poi %}Update{% else %}Save{% endif %} Point of Interest
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
    /* Card Styling */
    .form-card {
        background: linear-gradient(to right bottom, rgba(255, 255, 255, 0.8), rgba(255, 255, 255, 0.5));
        backdrop-filter: blur(10px);
        border: none;
        border-radius: 1rem;
        box-shadow: 0 10px 30px rgba(0,0,0,0.08);
        overflow: hidden;
        animation: slideUp 0.5s ease-out;
    }

    .form-card .card-header {
        background: linear-gradient(135deg, var(--main-color), var(--2nd-color));
        border-bottom: none;
        padding: 1.5rem;
        color: #333;
    }

    /* Form Elements */
    .form-label {
        font-family: var(--navfont);
        font-weight: 600;
        color: #333;
        margin-bottom: 0.5rem;
    }

    .form-control, .form-select {
        border-radius: 0.5rem;
        border: 1px solid rgba(255, 255, 255, 0.8);
        background: rgba(255, 255, 255, 0.5);
        backdrop-filter: blur(5px);
        padding: 0.8rem;
        transition: all 0.3s ease;
    }

    .form-control:focus, .form-select:focus {
        box-shadow: 0 0 0 0.25rem rgba(73, 170, 244, 0.25);
        border-color: rgba(73, 170, 244, 0.5);
        background: rgba(255, 255, 255, 0.8);
    }

    .input-group-text {
        border-radius: 0.5rem 0 0 0.5rem;
        border: 1px solid rgba(255, 255, 255, 0.8);
        background: rgba(255, 255, 255, 0.7);
        color: #555;
    }

    /* Image Preview */
    .image-preview {
        width: 150px;
        height: 150px;
        display: flex;
        align-items: center;
        justify-content: center;
        background: linear-gradient(to right bottom, rgba(255, 255, 255, 0.9), rgba(255, 255, 255, 0.5));
        border-radius: 0.5rem;
        box-shadow: 0 4px 10px rgba(0, 0, 0, 0.05);
        color: #aaa;
        font-size: 1.8rem;
        border: 2px dashed rgba(0, 0, 0, 0.1);
        transition: all 0.3s ease;
        overflow: hidden;
    }

    .current-image {
        width: 100%;
        height: 100%;
        object-fit: cover;
    }

    /* Map Styling */
    .map-container-wrapper {
        height: 100%;
        display: flex;
        flex-direction: column;
    }

    .map-container {
        flex-grow: 1;
        min-height: 400px;
        border-radius: 0.5rem;
        overflow: hidden;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        border: 2px solid rgba(255, 255, 255, 0.8);
    }

    /* Divider */
    .form-divider {
        height: 1px;
        background: linear-gradient(to right, rgba(255, 255, 255, 0), rgba(73, 170, 244, 0.5), rgba(255, 255, 255, 0));
        margin: 1.5rem 0;
    }

    /* Buttons */
    .submit-btn {
        background: linear-gradient(45deg, var(--nav-color1), var(--nav-color2));
        color: white;
        box-shadow: 0 4px 15px rgba(73, 170, 244, 0.3);
        border-radius: 2rem;
        padding: 0.8rem 2rem;
        border: none;
        transition: all 0.3s ease;
        font-weight: 500;
    }

    .submit-btn:hover {
        box-shadow: 0 8px 20px rgba(73, 170, 244, 0.4);
        transform: translateY(-2px);
    }

    .back-btn {
        background: rgba(255, 255, 255, 0.5);
        color: #555;
        border-radius: 2rem;
        padding: 0.8rem 2rem;
        border: 1px solid rgba(255, 255, 255, 0.8);
        transition: all 0.3s ease;
        font-weight: 500;
    }

    .back-btn:hover {
        background: rgba(255, 255, 255, 0.8);
        color: #333;
        box-shadow: 0 4px 10px rgba(0, 0, 0, 0.05);
    }

    /* Breadcrumb */
    .breadcrumb-nav {
        background: linear-gradient(to right bottom, rgba(255, 255, 255, 0.7), rgba(255, 255, 255, 0.3));
        backdrop-filter: blur(5px);
        padding: 0.8rem 1.5rem;
        border-radius: 2rem;
        animation: fadeIn 0.5s ease-out;
        box-shadow: 0 4px 10px rgba(0, 0, 0, 0.03);
    }

    .breadcrumb {
        margin-bottom: 0;
    }

    .breadcrumb-item a {
        color: var(--nav-color2);
        font-weight: 500;
        text-decoration: none;
        transition: all 0.2s ease;
    }

    .breadcrumb-item a:hover {
        color: var(--icon-poi);
        text-decoration: underline;
    }

    .breadcrumb-item.active {
        color: #555;
        font-weight: 500;
    }

    .breadcrumb-item+.breadcrumb-item::before {
        color: #aaa;
    }

    /* Enhanced tooltip styling */
    .leaflet-tooltip {
        background-color: rgba(255, 255, 255, 0.95);
        border: 1px solid rgba(73, 170, 244, 0.5);
        border-radius: 8px;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.15);
        padding: 8px 12px;
        font-size: 12px;
        font-family: var(--navfont, Arial, sans-serif);
        max-width: 250px;
        white-space: normal;
        word-wrap: break-word;
        line-height: 1.4;
        color: #333;
        transition: all 0.2s ease;
        text-overflow: ellipsis;
        overflow: hidden;
        direction: rtl; /* For Arabic support */
    }

    /* Make tooltip stand out more on hover */
    .leaflet-tooltip:hover {
        box-shadow: 0 6px 20px rgba(0, 0, 0, 0.2);
        transform: translateY(-1px);
    }

    /* POI tooltip styling */
    .poi-tooltip {
        display: flex;
        flex-direction: column;
        gap: 5px;
    }

    .poi-name {
        font-weight: bold;
        font-size: 13px;
        color: #0078A8;
        border-bottom: 1px solid rgba(0, 120, 168, 0.2);
        padding-bottom: 4px;
        margin-bottom: 4px;
    }

    .poi-address {
        font-size: 11px;
        color: #555;
    }

    /* Loading indicator */
    .address-loading {
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 3px 0;
        color: #666;
        font-style: italic;
    }

    .address-loading:after {
        content: '';
        width: 12px;
        height: 12px;
        margin-right: 10px;
        border: 2px solid rgba(73, 170, 244, 0.5);
        border-top: 2px solid transparent;
        border-radius: 50%;
        animation: spinner 0.8s linear infinite;
    }

    /* Animations */
    @keyframes fadeIn {
        from { opacity: 0; }
        to { opacity: 1; }
    }

    @keyframes slideUp {
        from {
            opacity: 0;
            transform: translateY(20px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    @keyframes spinner {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }

    /* Marker pulse animation */
    @keyframes markerPulse {
        0% {
            transform: scale(1);
        }
        50% {
            transform: scale(1.3);
        }
        100% {
            transform: scale(1);
        }
    }

    .marker-pulse {
        animation: markerPulse 0.8s ease-out;
    }
</style>

<!-- Leaflet CSS and JS -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>

<script>
    // Initialize map variables
    let map;
    let marker;

    // Function to get address from coordinates (reverse geocoding)
    async function getAddressFromCoordinates(lat, lng) {
        try {
            const response = await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lng}&zoom=18&addressdetails=1`);
            const data = await response.json();

            if (data && data.display_name) {
                // Format the address to make it more concise
                // Option 1: Use the full address but truncate if needed
                let address = data.display_name;
                if (address.length > 100) {
                    // If too long, try to use a more condensed version
                    address = formatAddressParts(data.address);
                }
                return address;
            } else {
                console.error("No address found");
                return null;
            }
        } catch (error) {
            console.error("Error fetching address:", error);
            return null;
        }
    }

    // Helper function to format address parts into a more concise string
    function formatAddressParts(addressParts) {
        if (!addressParts) return "Location selected";

        const parts = [];

        // Add the most important parts in order of specificity
        if (addressParts.road) parts.push(addressParts.road);
        if (addressParts.suburb) parts.push(addressParts.suburb);
        if (addressParts.city || addressParts.town || addressParts.village) {
            parts.push(addressParts.city || addressParts.town || addressParts.village);
        }
        if (addressParts.state || addressParts.province) {
            parts.push(addressParts.state || addressParts.province);
        }
        if (addressParts.country) parts.push(addressParts.country);

        // Join with commas
        return parts.join(", ");
    }

    function initMap() {
        // Default coordinates or existing POI coordinates
        const lat = {{ poi.latitude|default:'24.7136' }};
        const lng = {{ poi.longitude|default:'46.6753' }};

        map = L.map('map').setView([lat, lng], 13);

        // Use a nicer map style
        L.tileLayer('https://{s}.tile.openstreetmap.fr/hot/{z}/{x}/{y}.png', {
            attribution: '© OpenStreetMap contributors, Tiles style by Humanitarian OpenStreetMap Team'
        }).addTo(map);

        // Custom marker icon
        const customIcon = L.icon({
            iconUrl: 'https://cdn.jsdelivr.net/npm/leaflet@1.7.1/dist/images/marker-icon.png',
            shadowUrl: 'https://cdn.jsdelivr.net/npm/leaflet@1.7.1/dist/images/marker-shadow.png',
            iconSize: [25, 41],
            iconAnchor: [12, 41],
            popupAnchor: [1, -34],
            shadowSize: [41, 41]
        });

        // Add marker
        marker = L.marker([lat, lng], {
            draggable: true,
            icon: customIcon
        }).addTo(map);

        // Define a function to update tooltip content
        function updateTooltipContent(address) {
            let poiName = document.getElementById('name').value || "Point of Interest";
            const tooltipContent = `
                <div class="poi-tooltip">
                    <div class="poi-name">${poiName}</div>
                    <div class="poi-address">${address}</div>
                </div>
            `;

            // Check if tooltip exists first
            if (marker.getTooltip()) {
                marker.setTooltipContent(tooltipContent);
            } else {
                marker.bindTooltip(tooltipContent, { offset: [0, -35] }).openTooltip();
            }
        }

        // Initialize with default tooltip
        const initialPOIName = document.getElementById('name').value || "Point of Interest";
        const initialTooltipContent = `
            <div class="poi-tooltip">
                <div class="poi-name">${initialPOIName}</div>
                <div class="poi-address">جاري تحميل العنوان...</div>
            </div>
        `;
        marker.bindTooltip(initialTooltipContent, { offset: [0, -35] }).openTooltip();

        // Get address for initial marker position
        getAddressFromCoordinates(lat, lng)
            .then(address => {
                if (address) {
                    updateTooltipContent(address);
                    // If no location is set yet, update the location field
                    if (!document.getElementById('location').value) {
                        document.getElementById('location').value = address;
                    }
                } else {
                    updateTooltipContent("موقع محدد");
                }
            });

        // Listen for changes to the name field to update the tooltip
        document.getElementById('name').addEventListener('input', function() {
            const currentAddress = document.getElementById('location').value || "موقع محدد";
            updateTooltipContent(currentAddress);
        });

        // Update coordinates and address when marker is dragged
        marker.on('dragend', function(event) {
            const position = marker.getLatLng();
            document.getElementById('latitude').value = position.lat.toFixed(6);
            document.getElementById('longitude').value = position.lng.toFixed(6);

            // Add a pulse effect to the marker when dropped
            marker._icon.classList.add('marker-pulse');
            setTimeout(() => {
                marker._icon.classList.remove('marker-pulse');
            }, 800);

            // Update tooltip with loading indicator
            updateTooltipContent("جاري تحميل العنوان...");

            // Get and update address
            getAddressFromCoordinates(position.lat, position.lng)
                .then(address => {
                    if (address) {
                        updateTooltipContent(address);
                        document.getElementById('location').value = address;
                    } else {
                        updateTooltipContent("تعذر تحديد العنوان");
                    }
                })
                .catch(() => {
                    updateTooltipContent("تعذر تحميل العنوان");
                });
        });

        // Update marker position and address when clicking on map
        map.on('click', function(event) {
            marker.setLatLng(event.latlng);
            document.getElementById('latitude').value = event.latlng.lat.toFixed(6);
            document.getElementById('longitude').value = event.latlng.lng.toFixed(6);

            // Add a pulse effect to the marker when clicked
            marker._icon.classList.add('marker-pulse');
            setTimeout(() => {
                marker._icon.classList.remove('marker-pulse');
            }, 800);

            // Update tooltip with loading indicator
            updateTooltipContent("جاري تحميل العنوان...");

            // Get and update address
            getAddressFromCoordinates(event.latlng.lat, event.latlng.lng)
                .then(address => {
                    if (address) {
                        updateTooltipContent(address);
                        document.getElementById('location').value = address;
                    } else {
                        updateTooltipContent("تعذر تحديد العنوان");
                    }
                })
                .catch(() => {
                    updateTooltipContent("تعذر تحميل العنوان");
                });
        });
    }

    // Form validation
    (function () {
        'use strict'
        var forms = document.querySelectorAll('.needs-validation')
        Array.prototype.slice.call(forms)
            .forEach(function (form) {
                form.addEventListener('submit', function (event) {
                    if (!form.checkValidity()) {
                        event.preventDefault()
                        event.stopPropagation()
                    }
                    form.classList.add('was-validated')
                }, false)
            })
    })()

    // Image preview
    document.addEventListener('DOMContentLoaded', function() {
        document.getElementById('image').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(event) {
                    const img = document.createElement('img');
                    img.src = event.target.result;
                    img.style.width = '100%';
                    img.style.height = '100%';
                    img.style.objectFit = 'cover';
                    img.style.borderRadius = '0.3rem';
                    img.classList.add('current-image');

                    const preview = document.getElementById('imagePreview');
                    preview.innerHTML = '';
                    preview.appendChild(img);
                    preview.style.border = 'none';
                }
                reader.readAsDataURL(file);
            }
        });

        // Initialize map when DOM is loaded
        initMap();
        // Make sure map is properly sized
        setTimeout(function() {
            map.invalidateSize();
        }, 100);
    });
</script>
{% endblock %}